## Performance testing setup

Performance testing for artipie is done by two GitHub runners, with their workflow files committed in the `artipie/artpie` project. Test script from `artipie/benchmark` repository are used.
Currently tests run for single localhost and for ethernet connections between two machines. Localhost results are more stable, due to escaping all extra routing and security software checks in the host OSes.
These workflows do tests and generate two sets of graphs: for git tags: `v*` (releases) and git tags `t*` (test tags).

### Test setup:

```
2xPC: wsl-client, wsl-server:
Intel i7-8700 / 2666MHz DDR4 / NVME Samsung SSD
1GBit Ethernet for tests
USB Wi-Fi 2.4GHz, NAT Internet
MS Windows 11 22H2, WSL2g, Linux Ubuntu 22.04 LTS
Turbo Boost: off; CPU Mitigations: off; Hyper-threading: on
GitHub Runner for Linux (in WSL)
```


### WSL

MS Windows WSL2 + Ubuntu 22.04 Linux is used to host testing environment. It also isolates it from security software, which makes results less stable.
In WSL config CPU cores count is reduced from 12 to 6 to spare resources for background tasks in Host OS, so results in the guest could be more stable.
Turbo Boost and CPU Mitigations were also disabled on both hosts and guests to make results more predictable.

`C:\Users\<User>\.wslconfig`:
```
[wsl2]
kernelCommandLine="sysctl.vm.swappiness=10 mitigations=off"
processors=6
swap=8GB
```


### Linux dependencies
```
sudo apt install -y bzip2 docker.io python3-pip openjdk-17-jre-headless

sudo usermod -a -G docker,video,kvm,dialout $USER 
```


### GitHub Runners

Currently runners for Artipie performance testing must be started as root. Docker daemon must be started for both machines.

```
sudo -b nohup dockerd >/tmp/docker.log 2>&1
cd wsl-artipie-client-runner
sudo -b RUNNER_ALLOW_RUNASROOT=1 nohup ./run.sh
```

```
sudo -b nohup dockerd >/tmp/docker.log 2>&1
cd wsl-artipie-server-runner
sudo -b RUNNER_ALLOW_RUNASROOT=1 nohup ./run.sh
```


### Test settings file

Since we host testing actions locally, essential settings were put in the locally stored settings file on both machines.

#### `wsl-client` runner machine:
```
cat /opt/.benchvars

PUSH_TOKEN="ghp_***"
SERVER_HOST="169.254.229.145"
REPO_PORT=18081
DOCKER_PORT=12375
UPLOAD_LOGIN=***
UPLOAD_PASSWORD=***
```

#### `wsl-server` runner machine:
```
cat /opt/.benchvars

PUSH_TOKEN="ghp_***"
SERVER_HOST="localhost"
REPO_PORT=8081
DOCKER_PORT=2375
UPLOAD_LOGIN=***
UPLOAD_PASSWORD=***
```


### Usage notes
```
After reboots for the testing bench and WSL and services start, wait for at least 10 minutes, so background tasks may finish their activity and don't affect performance testing.
```


### Network configuration

Internet connection is required for testing workflows. It is provided by host OS Wi-Fi connections. For several reasons, manual reconnect is required ~ every 3 weeks.
Two PCs connected by ~0.8m ethernet cable for performance testing.
Port forwarding is required on the host (MS Windows) side, so they could be available from another testing host.

#### wsl-client 
```
# netsh.exe interface portproxy dump

reset
add v4tov4 listenport=22221 connectaddress=127.0.0.1 connectport=22222 # WSL SSH
add v4tov4 listenport=18081 connectaddress=127.0.0.1 connectport=8081  # WSL Artipie
```

#### wsl-server

##### TCP Ports forwarding

```
# netsh.exe interface portproxy dump

reset
add v4tov4 listenport=18081 connectaddress=127.0.0.1 connectport=8081  # WSL Artipie
add v4tov4 listenport=22221 connectaddress=127.0.0.1 connectport=22222 # WSL SSH
add v4tov4 listenport=18086 connectaddress=127.0.0.1 connectport=8086  # Artipie REST API
add v4tov4 listenport=19090 connectaddress=127.0.0.1 connectport=9090  # Monitoring, prometheus component. Currently unused.
add v4tov4 listenport=18080 connectaddress=127.0.0.1 connectport=8080  # WSL Artipie 
add v4tov4 listenport=12375 connectaddress=127.0.0.1 connectport=2375  # WSL Docker daemon
```

##### WSL Docker daemon remote access
```
sudo nano /etc/docker/daemon.json

{
  "hosts": ["unix:///var/run/docker.sock", "tcp://127.0.0.1:2375"]
}

sudo killall dockerd
sudo -b nohup dockerd >/tmp/docker.log 2>&1
```


### Performance testing results

Currently tests run for single localhost and for ethernet connections between two machines. Results are stored in the following remote directories:

- `https://central.artipie.com/artipie/benchmarks`
- `https://central.artipie.com/artipie/benchmarks/localhost`

Every directory has the following structure:

- `perftests_repo/perftests/<tag>/<testname>/statistics.json` stores individual test result files generated by Apache JMeter.
- `perftests_repo/jfr/artipie.last.jfr.tar.xz` JFR metrics for artipie server are recorded during whole run time of the test set and archived results are uploaded to this URL.
- `perftests_repo/graphs_v/<testname>.svg` graphs generated for `v*` all tags (releases).
- `perftests_repo/graphs_t/<testname>.svg` graphs generated for all `t*` tags (test tags).
- `perftests_repo/graphs/<testname>.svg` graphs generated for all tags.


### Result URLs

#### Last JFR data
- whole test set run: https://central.artipie.com/artipie/benchmarks/perftests_repo/jfr/artipie.last.jfr.tar.xz
- localhost part only: https://central.artipie.com/artipie/benchmarks/localhost/perftests_repo/jfr/artipie.last.jfr.tar.xz

#### Graphs for releses
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_v/jmx-files-ul.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_v/jmx-files-dl.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_v/jmx-files-maven-ul.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_v/jmx-files-maven-dl.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_v/jmx-maven-ul.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_v/jmx-maven-dl.svg

#### Graphs for test tags
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_t/jmx-files-ul.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_t/jmx-files-dl.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_t/jmx-files-maven-ul.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_t/jmx-files-maven-dl.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_t/jmx-maven-ul.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs_t/jmx-maven-dl.svg

#### Graphs for all tags
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs/jmx-files-ul.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs/jmx-files-dl.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs/jmx-files-maven-ul.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs/jmx-files-maven-dl.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs/jmx-maven-ul.svg
- https://central.artipie.com/artipie/benchmarks/perftests_repo/graphs/jmx-maven-dl.svg
